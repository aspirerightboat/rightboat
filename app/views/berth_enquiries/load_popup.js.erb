(function() {
  var map, marker;

  function initMap() {
    map = new google.maps.Map(document.getElementById('select-map'), {
      zoom: 5,
      center: {lat: 51.5286416, lng: -0.1015987 },
      disableDoubleClickZoom: true,
      mapTypeControl: false,
      navigationControl: false,
      streetViewControl: false
    });

    map.addListener('click', function(e) {
      placeMarkerAndPanTo(e.latLng, map);
    });
  }

  function placeMarkerAndPanTo(latLng, map) {
    if (marker) marker.setMap(null);

    var geocorder = new (google.maps.Geocoder);
    geocorder.geocode({location: latLng}, function (results, status) {
      if (status === google.maps.GeocoderStatus.OK) {
        if (results[0]) {
          var location = results[0].formatted_address;
          $('#berth_enquiry_location').val(location);
          $('#location_address').html(location);
          $('#berth_enquiry_latitude').val(latLng.lat());
          $('#berth_enquiry_longitude').val(latLng.lng());

          marker = new google.maps.Marker({
            position: latLng,
            map: map,
            title: location
          });
          map.panTo(latLng);
        } else {
          alert('No result found.');
        }
      } else {
        alert('Geocoder failed due to: ' + status);
      }
    });
  }

  $(function() {
    $(document.body).append('<%=j render partial: 'berth_enquiries/form' %>');

    var $popup = $('#berths_popup').simpleAjaxForm();

    window.initSlider($('.slider', $popup));

    $popup.on('shown.bs.modal', function() {
      initMap();
    });
  });
})();
